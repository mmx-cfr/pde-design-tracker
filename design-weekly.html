<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Tasks – Full Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
/*      line-height: 1.5;*/
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 1.5rem;
    }
    #controls {
      margin-bottom: 1.25rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    select {
      padding: 0.4rem;
      font-size: 1rem;
    }
    h2 {
      /* optional styling */
      margin: 0;
      font-size: 1.25rem;
    }
    ul {
      margin: 0.25rem 0 0.9rem 0rem;
      padding: 0;
    }
    li {
      margin-bottom: 0.25rem;
      list-style-type: none;

    }
    .due {
      color: #333;
/*      font-size: 0.85rem;*/
        font-size: smaller !important;
    }
    .loe {
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid #aaa;
      padding: 0 0.4rem;
      margin-left: 0.4rem;
      text-transform: uppercase;
      float: right;
    }
    #status {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 1.25rem;
    }

    .person-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-top: 1.75rem;
    }

    .person-header img {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      object-fit: cover;
      border: 1px solid #ccc;
    }

    #output p {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Weekly Tasks – Design Team</h1>

  <div id="controls">
    <select id="weekSelect"></select>
  </div>

  <div id="status">Loading…</div>
  <div id="output"></div>

<script>
/* ============================================================
   1. CONFIG
   ============================================================ */

const AIRTABLE_PAT = "patECZqY16UpaPX7M.7d8ca3f0ad394c03c5acf69927a21d2c855a74daeb90b043f72f1dee377faef7";

const CONFIG = {
  Erik: {
    img: "https://ca.slack-edge.com/E07UFG9853K-U09K1JSAE7M-c915a20580e2-512",
    base: "app4yC3zu0WUh99dR",
    table: "Tracker",
    fields: {
      project: "Project / Description",
      start: "Start Date",      // new
      due: "Due Date",          // treated as end if no End Date
      loe: "Level of Effort"
      // TASKS is a shared field name in each table (optional)
    }
  },
  Michael: {
    img: "https://ca.slack-edge.com/E07UFG9853K-UBR3SU9FW-f31afeb2ec66-512",
    base: "app13LGJt1iOMZaM9",
    table: "Design Projects",
    fields: {
      project: "Phase & Action",
      start: "Start Date",      // new
      due: "Due Date",
      loe: "Level of Effort"
    }
  },
  Juliann: {
    img: "https://ca.slack-edge.com/E07UFG9853K-U05FY0D866T-66fe4f979055-512",
    base: "app3R7828hbnc6uCH",
    table: "All Projects",
    fields: {
      project: "Project Name",
      action: "Action & Phases",
      start: "Start Date",      // new
      due: "Due Date"
    }
  },
  Sean: {
    img: "https://ca.slack-edge.com/E07UFG9853K-U04KBAEU36F-0047e33f77bd-512",
    base: "app8RT1ivyhMzVokV",
    table: "All Projects",
    fields: {
      project: "Project Name",
      action: "Action & Phases",
      start: "Start Date",      // new
      due: "Due Date"
    }
  },
  Sabine: {
    img: "https://ca.slack-edge.com/E07UFG9853K-U5NRTASUC-66702a3de5da-72",
    base: "appxb7mqEjqEv0AEF",
    table: "Tracker",
    fields: {
      project: "Project / Description",
      content: "Content Title",
      loe: "Level of Effort",
      start: "Start Date",
      end: "End Date",          // if present, use as end
      due: "Due Date"           // fallback end if End Date missing
    }
  }
};

/* ============================================================
   2. AIRTABLE FETCH WITH PAGINATION
   ============================================================ */

async function fetchAllRecords(baseId, table) {
  let all = [];
  let offset = null;

  do {
    let url = new URL(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(table)}`);
    if (offset) url.searchParams.set("offset", offset);

    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${AIRTABLE_PAT}` }
    });
    if (!res.ok) throw new Error("Airtable error " + res.status);

    const json = await res.json();
    all = all.concat(json.records);
    offset = json.offset;
  } while (offset);

  return all;
}

/* ============================================================
   3. DATE HELPERS
   ============================================================ */

function forceISO(s) {
  if (!s) return null;
  if (s instanceof Date) return s;
  if (s.includes("T")) return new Date(s);
  return new Date(s + "T00:00:00");
}

function formatPretty(s) {
  const d = forceISO(s);
  if (!d) return s;
  return d.toLocaleDateString(undefined, {
    year: "numeric",
    month: "long",
    day: "numeric"
  });
}

function getSunday(mondayStr) {
  const d = forceISO(mondayStr);
  d.setDate(d.getDate() + 6);
  return d.toISOString().slice(0, 10);
}

/* ============================================================
   4. WEEK DROPDOWN — ± 6 months
   ============================================================ */

function populateWeekDropdown() {
  const select = document.getElementById("weekSelect");
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const day = today.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  const baseMonday = new Date(today);
  baseMonday.setDate(today.getDate() + diff);

  const weeks = [];
  const weeksBack = 26;
  const weeksForward = 26;

  for (let i = -weeksBack; i <= weeksForward; i++) {
    const m = new Date(baseMonday);
    m.setDate(baseMonday.getDate() + i * 7);
    const ms = m.toISOString().slice(0, 10);
    const ss = getSunday(ms);
    weeks.push({ value: ms, label: `${formatPretty(ms)} → ${formatPretty(ss)}` });
  }

  // Sort descending: future → past
  weeks.sort((a, b) => new Date(b.value) - new Date(a.value));

  for (const w of weeks) {
    const opt = document.createElement("option");
    opt.value = w.value;
    opt.textContent = w.label;
    select.appendChild(opt);
  }

  select.value = baseMonday.toISOString().slice(0, 10);
}

/* ============================================================
   5. TASKS PARSER & RANGE HELPERS
   ============================================================ */

function parseTasks(tasksText, fallbackYear) {
  if (!tasksText) return [];

  // Accept "-", "–", or "—"
  const DASH = "[-–—]";

  const lines = tasksText
    .split(/\n+/)
    .map(l => l.trim())
    .filter(Boolean);

  const parsed = [];
  let currentYear = fallbackYear;
  let lastMonth = null;

  // --------------------------------------------------------------------
  // Two-date RANGE pattern:
  //   11/26–12/05 – Description
  //   11/26-12/05—Description
  //   11/26/2025–12/05/2025 – Description
  //
  // Regex breakdown:
  //   MM/DD(/YYYY)?  DASH  MM/DD(/YYYY)?  DASH  description
  // --------------------------------------------------------------------
  const rangeRegex = new RegExp(
    `^(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{4}))?\\s*${DASH}\\s*(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{4}))?\\s*${DASH}\\s*(.+)$`
  );

  // --------------------------------------------------------------------
  // Single-date pattern:
  //   12/6 – Publish Lorem Ipsum
  //   12/6—Publish
  //   12/6/2025 - Review
  // --------------------------------------------------------------------
  const singleRegex = new RegExp(
    `^(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{4}))?\\s*${DASH}\\s*(.+)$`
  );

  for (let line of lines) {
    let m = line.match(rangeRegex);

    if (m) {
      let m1 = parseInt(m[1], 10);
      let d1 = parseInt(m[2], 10);
      let y1 = m[3] ? parseInt(m[3], 10) : currentYear;

      let m2 = parseInt(m[4], 10);
      let d2 = parseInt(m[5], 10);
      let y2 = m[6] ? parseInt(m[6], 10) : currentYear;

      // Handle year rollover when year is missing
      if (!m[6] && m2 < m1) {
        y2 = y1 + 1;
      }

      currentYear = y2;
      lastMonth = m2;

      const startISO = new Date(y1, m1 - 1, d1).toISOString().slice(0, 10);
      const endISO   = new Date(y2, m2 - 1, d2).toISOString().slice(0, 10);

      parsed.push({
        start: startISO,
        end: endISO,
        desc: m[7]
      });

      continue;
    }

    // SINGLE DATE
    m = line.match(singleRegex);
    if (m) {
      let month = parseInt(m[1], 10);
      let day   = parseInt(m[2], 10);
      let year  = m[3] ? parseInt(m[3], 10) : currentYear;
      const desc = m[4];

      if (lastMonth !== null && month < lastMonth && !m[3]) {
        year++;
        currentYear = year;
      }

      lastMonth = month;

      const iso = new Date(year, month - 1, day).toISOString().slice(0, 10);

      parsed.push({
        start: iso,
        end: iso,
        desc
      });

      continue;
    }
  }

  return parsed;
}



function dateInWeek(isoDate, mondayStr) {
  const d = forceISO(isoDate);
  if (!d) return false;
  const monday = forceISO(mondayStr);
  const sunday = forceISO(getSunday(mondayStr));
  return d >= monday && d <= sunday;
}

function rangeOverlapsWeek(startStr, endStr, mondayStr) {
  const start = forceISO(startStr);
  const end   = forceISO(endStr);
  if (!start || !end) return false;

  const monday = forceISO(mondayStr);
  const sunday = forceISO(getSunday(mondayStr));

  // Overlap if start ≤ sunday AND end ≥ monday
  return (start <= sunday && end >= monday);
}

// For each record: determine start and end using config fields
function getRecordRange(fields, cfg) {
  const startField = cfg.fields.start;
  const endField   = cfg.fields.end;
  const dueField   = cfg.fields.due;

  let start = startField ? fields[startField] : null;
  let end = null;

  if (endField && fields[endField]) {
    end = fields[endField];
  } else if (dueField && fields[dueField]) {
    end = fields[dueField];
  } else if (start) {
    end = start;
  }

  // If no start but we do have an end, treat end as both start and end
  if (!start && end) {
    start = end;
  }

  return { start, end };
}

// For TASKS fallback year: prefer a known date from the record
function getFallbackYear(fields, cfg) {
  const { start, end } = getRecordRange(fields, cfg);
  let baseDate = null;

  if (end) baseDate = end;
  else if (start) baseDate = start;

  if (baseDate) {
    return forceISO(baseDate).getFullYear();
  }
  return new Date().getFullYear();
}

function buildLabel(project, content, action) {
  if (content) return `${project || "(No description)"} – ${content}`;
  if (action) return `${project || "(No description)"} – ${action}`;
  return project || "(No description)";
}

/* ============================================================
   6. MAIN LOAD LOGIC (Revisions 1 & 2)
   ============================================================ */

async function loadWeek() {
  const status = document.getElementById("status");
  const mondayStr = document.getElementById("weekSelect").value;

  status.textContent = "Loading…";
  document.getElementById('output').style.visibility = 'hidden';

  

  try {
    const data = await Promise.all(
      Object.entries(CONFIG).map(async ([name, cfg]) => {
        const recs = await fetchAllRecords(cfg.base, cfg.table);
        const personTasks = [];

        for (const r of recs) {
          const f = r.fields;

          const project = f[cfg.fields.project];
          const content = cfg.fields.content ? f[cfg.fields.content] : null;
          const action  = cfg.fields.action  ? f[cfg.fields.action]  : null;
          const labelBase = buildLabel(project, content, action);

          const loe = cfg.fields.loe ? (f[cfg.fields.loe] || "") : "";

          // const tasksTextRaw = f["TASKS"];
          const tasksTextRaw = f["TASKS"] || f["Tasks"] || f["tasks"];

          const hasTasks = tasksTextRaw && tasksTextRaw.trim().length > 0;

          // TASKS override continuous week logic
          if (hasTasks) {
            const fallbackYear = getFallbackYear(f, cfg);
            const parsed = parseTasks(tasksTextRaw, fallbackYear);

            for (const item of parsed) {
              if (rangeOverlapsWeek(item.start, item.end, mondayStr)) {
                // show the END date in the UI as the due date
                personTasks.push({
                  name,
                  label: `${labelBase} – ${item.desc}`,
                  due: item.end,
                  loe
                });
              }
            }
            continue; // skip continuous range logic for this record
          }

          // No TASKS: show in every week overlapping [Start → End/Due]
          const { start, end } = getRecordRange(f, cfg);
          if (!start || !end) {
            // If neither start nor end present, we have no temporal info; skip
            continue;
          }

          if (rangeOverlapsWeek(start, end, mondayStr)) {
            const displayDue = end || start;
            personTasks.push({
              name,
              label: labelBase,
              due: displayDue,
              loe
            });
          }
        }

        // Sort each person's tasks by date
        personTasks.sort((a, b) => {
          const da = forceISO(a.due);
          const db = forceISO(b.due);
          return da - db;
        });

        return [name, personTasks];
      })
    );

    render(Object.fromEntries(data), mondayStr);
    status.textContent = "";
    document.getElementById('output').style.visibility = 'visible';

  } catch (e) {
    console.error(e);
    status.textContent = "Error loading data.";
  }
}

/* ============================================================
   7. RENDER
   ============================================================ */

function formatShortPretty(iso) {
  const d = forceISO(iso);
  if (!d) return iso;

  const currentYear = new Date().getFullYear();
  const weekday = d.toLocaleDateString(undefined, { weekday: "short" }).replace(/\.$/, "");
  const month = d.toLocaleDateString(undefined, { month: "short" }).replace(/\.$/, "") + ".";
  const day = d.getDate();
  const year = d.getFullYear();

  if (year === currentYear) {
    return `${weekday}, ${month} ${day}`;
  } else {
    return `${weekday}, ${month} ${day}, ${year}`;
  }
}


function render(allData, mondayStr) {
  const out = document.getElementById("output");
  out.innerHTML = "";

  const p = document.createElement("p");
  p.innerHTML = `<strong>Week:</strong> ${formatPretty(mondayStr)} → ${formatPretty(getSunday(mondayStr))}`;
  out.appendChild(p);

  for (const [name, tasks] of Object.entries(allData)) {
    const header = document.createElement("div");
    header.className = "person-header";

    const img = document.createElement("img");
    img.src = CONFIG[name].img || "";
    img.alt = name;

    const h = document.createElement("h2");
    h.textContent = name;

    header.appendChild(img);
    header.appendChild(h);
    out.appendChild(header);

    if (!tasks.length) {
      const pn = document.createElement("p");
      pn.textContent = "No tasks for this week.";
      out.appendChild(pn);
      continue;
    }

    // ======================================================
    // GROUP TASKS BY PROJECT
    // ======================================================
    const grouped = {};
    for (const t of tasks) {
      // Extract the project name from before the " – "
      const idx = t.label.indexOf("–");
      let project = t.label;
      let sub = "";

      if (idx !== -1) {
        project = t.label.slice(0, idx).trim();
        sub = t.label.slice(idx + 1).trim();
      }

      if (!grouped[project]) {
        grouped[project] = {
          loe: t.loe || "",
          list: []
        };
      }

      grouped[project].list.push({
        desc: sub,
        due: t.due
      });
    }

    // ======================================================
    // RENDER EACH PROJECT GROUP
    // ======================================================
    for (const [project, obj] of Object.entries(grouped)) {
      const wrap = document.createElement("div");
      wrap.style.margin = "0.5rem 0 0.5rem 0";

      // Project header
      const title = document.createElement("div");
      title.innerHTML = `<span class='project'>${project}:</span>`;
      // title.style.marginBottom = "0.3rem";

      // Add LOE on the right of the project header
      if (obj.loe) {
        const loe = document.createElement("span");
        loe.className = "loe";
        loe.textContent = obj.loe;
        title.appendChild(loe);
      }

      wrap.appendChild(title);

      // Task list
      const ul = document.createElement("ul");
      for (const item of obj.list) {
        const li = document.createElement("li");
        li.textContent = `${item.desc} `;
        const d = document.createElement("span");
        d.className = "due";

        d.textContent = `(Due ${formatShortPretty(item.due)})`;

        li.appendChild(d);
        ul.appendChild(li);
      }

      wrap.appendChild(ul);
      out.appendChild(wrap);
    }
  }
}


/* ============================================================
   8. INIT
   ============================================================ */

(async () => {
  populateWeekDropdown();
  document.getElementById("weekSelect").addEventListener("change", loadWeek);
  await loadWeek();
})();
</script>

</body>
</html>
